% ---------------------- %
% -- IMPORTS REQUIRED -- %
% ---------------------- %

% A
\RequirePackage{amssymb}
% C
\RequirePackage{centernot}
% E
\RequirePackage{etoolbox}
% L
\RequirePackage{longtable}
% M
\RequirePackage{mathtools}
% S
\RequirePackage{simplekv}
% T
\RequirePackage{tnscom}
% W
\RequirePackage{witharrows}


% --------------------- %
% -- SPACE LOGIC NEG -- %
% --------------------- %

% Logic negation roots

\let\stdneg\neg
\renewcommand\neg{%
    \stdneg\,%
}


% ----------------- %
% -- SPECIAL OPE -- %
% ----------------- %

% == Specific characters from mathabx == %

% Source:
%    * https://tex.stackexchange.com/a/585285/6880

\DeclareFontFamily{U}{mathb}{}
\DeclareFontShape{U}{mathb}{m}{n}{
  <-5.5> mathb5
  <5.5-6.5> mathb6
  <6.5-7.5> mathb7
  <7.5-8.5> mathb8
  <8.5-9.5> mathb9
  <9.5-11> mathb10
  <11-> mathb12
}{}
\DeclareSymbolFont{mathb}{U}{mathb}{m}{n}
\DeclareFontSubstitution{U}{mathb}{m}{n}

\DeclareMathSymbol{\tnslog@leftleftharpoons}  {3}{mathb}{"D8}
\DeclareMathSymbol{\tnslog@rightrightharpoons}{3}{mathb}{"D9}


\DeclareFontFamily{U}{matha}{}
\DeclareFontShape{U}{matha}{m}{n}{
  <-5.5> matha5
  <5.5-6.5> matha6
  <6.5-7.5> matha7
  <7.5-8.5> matha8
  <8.5-9.5> matha9
  <9.5-11> matha10
  <11-> matha12
}{}
\DeclareSymbolFont{matha}{U}{matha}{m}{n}
\DeclareFontSubstitution{U}{matha}{m}{n}

\DeclareMathSymbol{\tnslog@rightleftharpoons}{\mathrel}{matha}{"E9}


% == Vertical versions == %


\newcommand\viff{\mathrel{\Updownarrow}}
\newcommand\vimplies{\mathrel{\Downarrow}}
\newcommand\vbecauseof{\mathrel{\Uparrow}}

\newcommand\nviff{\centernot\viff}
\newcommand\nvimplies{\centernot\vimplies}
\newcommand\nvbecauseof{\centernot\vbecauseof}


% == Decorations - START == %

% Source for the short sysmbols.
%    * https://tex.stackexchange.com/a/585267/6880

\newcommand\shorteq{\mathrel{\mathpalette\shorteq@{.55}}}
\newcommand{\shorteq@}[2]{%
  \resizebox{#2\width}{\height}{$\m@th#1=$}%
}

\newcommand\shortless{\mathrel{\mathpalette\shortless@{.55}}}
\newcommand{\shortless@}[2]{%
  \resizebox{#2\width}{\height}{$\m@th#1<$}%
}

\newcommand\shortgtr{\mathrel{\mathpalette\shortgtr@{.55}}}
\newcommand{\shortgtr@}[2]{%
  \resizebox{#2\width}{\height}{$\m@th#1>$}%
}

% Decorable operators.

\newcommand\coldecoope{blue}

\newcommand\txtdecoope[1]{%
	\text{\tiny\color{\coldecoope}#1}%
}

\newcommand\eq{\@ifstar{\tnslog@eq@star}{\tnslog@eq@no@star}}

\newcommand\tnslog@eq@no@star[1][]{%
    \if\relax\detokenize{#1}\relax%
    	=%
    \else%
        \tns@over@math@symbol{\txtdecoope{#1}}{=}%
    \fi%
}

\newcommand\tnslog@eq@star[1][]{%
    \if\relax\detokenize{#1}\relax%
    	=%
    \else%
        \IfEqCase{#1}{%
            {?}{\shorteq\mkern1.5mu\shorteq}%
            {appli}{\tnslog@leftleftharpoons}%
            {cons}{\tnslog@rightrightharpoons}%
            {def}{\coloneqq}%
            {id}{\tnslog@rightleftharpoons}%
        }[%
            \tns@over@math@symbol{\txtdecoope{#1}}{=}%
        ]%
    \fi%
}

\let\oldneq\neq
\renewcommand\neq{\@ifstar{\tnslog@neq@star}{\tnslog@neq@no@star}}

\newcommand\tnslog@neq@no@star[1][]{%
    \if\relax\detokenize{#1}\relax%
    	\oldneq%
    \else%
        \tns@over@math@symbol{\txtdecoope{#1}}{\oldneq}%
    \fi%
}

\newcommand\tnslog@neq@star[1][]{%
    \if\relax\detokenize{#1}\relax%
    	\oldneq%
    \else%
        \IfEqCase{#1}{%
            {?}{\shortless\mkern1.5mu\shortgtr}%
            {appli}{\centernot\tnslog@leftleftharpoons}%
            {cons}{\centernot\tnslog@rightrightharpoons}%
            {def}{\centernot\coloneqq}%
            {id}{\centernot\tnslog@rightleftharpoons}%
        }[%
            \tns@over@math@symbol{\txtdecoope{#1}}{\oldneq}%
        ]%
    \fi%
}

\newcommand\less{\@ifstar{\tnslog@less@star}{\tnslog@less@no@star}}

\newcommand\tnslog@less@no@star[1][]{%
    \if\relax\detokenize{#1}\relax%
    	<%
    \else%
        \tns@over@math@symbol{\txtdecoope{#1}}{<}%
    \fi%
}

\newcommand\tnslog@less@star[1][]{%
    \if\relax\detokenize{#1}\relax%
    	<%
    \else%
        \tns@over@math@symbol{\txtdecoope{#1}}{<}%
    \fi%
}

\let\oldnless\nless
\renewcommand\nless{\@ifstar{\tnslog@nless@star}{\tnslog@nless@no@star}}

\newcommand\tnslog@nless@no@star[1][]{%
    \if\relax\detokenize{#1}\relax%
    	\oldnless%
    \else%
        \tns@over@math@symbol{\txtdecoope{#1}}{\oldnless}%
    \fi%
}

\newcommand\tnslog@nless@star[1][]{%
    \if\relax\detokenize{#1}\relax%
    	\oldnless%
    \else%
        \tns@over@math@symbol{\txtdecoope{#1}}{\oldnless}%
    \fi%
}

\newcommand\gtr{\@ifstar{\tnslog@gtr@star}{\tnslog@gtr@no@star}}

\newcommand\tnslog@gtr@no@star[1][]{%
    \if\relax\detokenize{#1}\relax%
    	>%
    \else%
        \tns@over@math@symbol{\txtdecoope{#1}}{>}%
    \fi%
}

\newcommand\tnslog@gtr@star[1][]{%
    \if\relax\detokenize{#1}\relax%
    	>%
    \else%
        \tns@over@math@symbol{\txtdecoope{#1}}{>}%
    \fi%
}

\let\oldngtr\ngtr
\renewcommand\ngtr{\@ifstar{\tnslog@ngtr@star}{\tnslog@ngtr@no@star}}

\newcommand\tnslog@ngtr@no@star[1][]{%
    \if\relax\detokenize{#1}\relax%
    	\oldngtr%
    \else%
        \tns@over@math@symbol{\txtdecoope{#1}}{\oldngtr}%
    \fi%
}

\newcommand\tnslog@ngtr@star[1][]{%
    \if\relax\detokenize{#1}\relax%
    	\oldngtr%
    \else%
        \tns@over@math@symbol{\txtdecoope{#1}}{\oldngtr}%
    \fi%
}

\let\oldleq\leq
\renewcommand\leq{\@ifstar{\tnslog@leq@star}{\tnslog@leq@no@star}}

\newcommand\tnslog@leq@no@star[1][]{%
    \if\relax\detokenize{#1}\relax%
    	\oldleq%
    \else%
        \tns@over@math@symbol{\txtdecoope{#1}}{\oldleq}%
    \fi%
}

\newcommand\tnslog@leq@star[1][]{%
    \if\relax\detokenize{#1}\relax%
    	\oldleq%
    \else%
        \tns@over@math@symbol{\txtdecoope{#1}}{\oldleq}%
    \fi%
}

\let\oldnleq\nleq
\renewcommand\nleq{\@ifstar{\tnslog@nleq@star}{\tnslog@nleq@no@star}}

\newcommand\tnslog@nleq@no@star[1][]{%
    \if\relax\detokenize{#1}\relax%
    	\oldnleq%
    \else%
        \tns@over@math@symbol{\txtdecoope{#1}}{\oldnleq}%
    \fi%
}

\newcommand\tnslog@nleq@star[1][]{%
    \if\relax\detokenize{#1}\relax%
    	\oldnleq%
    \else%
        \tns@over@math@symbol{\txtdecoope{#1}}{\oldnleq}%
    \fi%
}

\let\oldgeq\geq
\renewcommand\geq{\@ifstar{\tnslog@geq@star}{\tnslog@geq@no@star}}

\newcommand\tnslog@geq@no@star[1][]{%
    \if\relax\detokenize{#1}\relax%
    	\oldgeq%
    \else%
        \tns@over@math@symbol{\txtdecoope{#1}}{\oldgeq}%
    \fi%
}

\newcommand\tnslog@geq@star[1][]{%
    \if\relax\detokenize{#1}\relax%
    	\oldgeq%
    \else%
        \tns@over@math@symbol{\txtdecoope{#1}}{\oldgeq}%
    \fi%
}

\let\oldngeq\ngeq
\renewcommand\ngeq{\@ifstar{\tnslog@ngeq@star}{\tnslog@ngeq@no@star}}

\newcommand\tnslog@ngeq@no@star[1][]{%
    \if\relax\detokenize{#1}\relax%
    	\oldngeq%
    \else%
        \tns@over@math@symbol{\txtdecoope{#1}}{\oldngeq}%
    \fi%
}

\newcommand\tnslog@ngeq@star[1][]{%
    \if\relax\detokenize{#1}\relax%
    	\oldngeq%
    \else%
        \tns@over@math@symbol{\txtdecoope{#1}}{\oldngeq}%
    \fi%
}

\let\oldiff\iff
\renewcommand\iff{\@ifstar{\tnslog@iff@star}{\tnslog@iff@no@star}}

\newcommand\tnslog@iff@no@star[1][]{%
    \if\relax\detokenize{#1}\relax%
    	\oldiff%
    \else%
        \tns@over@math@symbol{\txtdecoope{#1}}{\oldiff}%
    \fi%
}

\newcommand\tnslog@iff@star[1][]{%
    \if\relax\detokenize{#1}\relax%
    	\oldiff%
    \else%
        \tns@over@math@symbol{\txtdecoope{#1}}{\oldiff}%
    \fi%
}

\newcommand\niff{\@ifstar{\tnslog@niff@star}{\tnslog@niff@no@star}}

\newcommand\tnslog@niff@no@star[1][]{%
    \if\relax\detokenize{#1}\relax%
    	\centernot\iff%
    \else%
        \tns@over@math@symbol{\txtdecoope{#1}}{\centernot\iff}%
    \fi%
}

\newcommand\tnslog@niff@star[1][]{%
    \if\relax\detokenize{#1}\relax%
    	\centernot\iff%
    \else%
        \tns@over@math@symbol{\txtdecoope{#1}}{\centernot\iff}%
    \fi%
}

\let\oldimplies\implies
\renewcommand\implies{\@ifstar{\tnslog@implies@star}{\tnslog@implies@no@star}}

\newcommand\tnslog@implies@no@star[1][]{%
    \if\relax\detokenize{#1}\relax%
    	\oldimplies%
    \else%
        \tns@over@math@symbol{\txtdecoope{#1}}{\oldimplies}%
    \fi%
}

\newcommand\tnslog@implies@star[1][]{%
    \if\relax\detokenize{#1}\relax%
    	\oldimplies%
    \else%
        \tns@over@math@symbol{\txtdecoope{#1}}{\oldimplies}%
    \fi%
}

\newcommand\nimplies{\@ifstar{\tnslog@nimplies@star}{\tnslog@nimplies@no@star}}

\newcommand\tnslog@nimplies@no@star[1][]{%
    \if\relax\detokenize{#1}\relax%
    	\centernot\implies%
    \else%
        \tns@over@math@symbol{\txtdecoope{#1}}{\centernot\implies}%
    \fi%
}

\newcommand\tnslog@nimplies@star[1][]{%
    \if\relax\detokenize{#1}\relax%
    	\centernot\implies%
    \else%
        \tns@over@math@symbol{\txtdecoope{#1}}{\centernot\implies}%
    \fi%
}

\newcommand\becauseof{\@ifstar{\tnslog@becauseof@star}{\tnslog@becauseof@no@star}}

\newcommand\tnslog@becauseof@no@star[1][]{%
    \if\relax\detokenize{#1}\relax%
    	\mathrel{\Longleftarrow}%
    \else%
        \tns@over@math@symbol{\txtdecoope{#1}}{\mathrel{\Longleftarrow}}%
    \fi%
}

\newcommand\tnslog@becauseof@star[1][]{%
    \if\relax\detokenize{#1}\relax%
    	\mathrel{\Longleftarrow}%
    \else%
        \tns@over@math@symbol{\txtdecoope{#1}}{\mathrel{\Longleftarrow}}%
    \fi%
}

\newcommand\nbecauseof{\@ifstar{\tnslog@nbecauseof@star}{\tnslog@nbecauseof@no@star}}

\newcommand\tnslog@nbecauseof@no@star[1][]{%
    \if\relax\detokenize{#1}\relax%
    	\centernot\becauseof%
    \else%
        \tns@over@math@symbol{\txtdecoope{#1}}{\centernot\becauseof}%
    \fi%
}

\newcommand\tnslog@nbecauseof@star[1][]{%
    \if\relax\detokenize{#1}\relax%
    	\centernot\becauseof%
    \else%
        \tns@over@math@symbol{\txtdecoope{#1}}{\centernot\becauseof}%
    \fi%
}

% == Decorations - END == %


% ----------------- %
% -- QUANTIFIERS -- %
% ----------------- %

\newcommand\existsone{\exists\kern0.1em !}
\newcommand\nexistsone{\nexists\kern0.1em !}

\newcommand\existmulti[1]{\exists_{\kern0.1em #1}}
\newcommand\nexistmulti[1]{\nexists_{\kern0.1em #1}}


% -------------- %
% -- STEPCALC -- %
% -------------- %

% Space

\newcommand\expltxtspacein{2em}


% Common tools

\newcommand\explcom[1]{%
    \text{\color{purple}[\kern.225em{\footnotesize \itshape #1}\kern.3em]}%
}


\newcommand\explnext{\@ifstar{\tnslog@expl@next@star}{\tnslog@expl@next@no@star}}
\newcommand\tnslog@expl@next@no@star{}
\newcommand\tnslog@expl@next@star{}


\newcommand\tnslog@step@calc@ope{=}


\newcommand\comthis{\@ifstar{\tnslog@com@this@star}{\tnslog@com@this@no@star}}
\newcommand\tnslog@com@this@no@star{}

\newcommand\tnslog@com@this@star[1]{%
    \ifbool{tnslog@start@step@calc@arrow@}{%
        \PackageError{tnslog}{comment can't be use to start stepcalc[style = sar]}%
                             {No comment for the 1st part of stepcalc[style = sar]}
    }{%
        \kern\expltxtspacein\explcom{#1}%
    }%
}


\newcommand\tnslog@com@this@aligned[1]{%
    \global\booltrue{tnslog@com@this@no@star@used}%
    &%
    \tnslog@com@this@star{#1}%
}


\newcommand\tnslog@expl@next@extra@column{}


% Wrapper env with key-val options 

\setKVdefault[tnslog@step@calc@keys]{%
    ope   = {=},
    style = u,
    com   = nal
}


\newbool{tnslog@inside@step@calc@short@arrow@star@}


\newenvironment{stepcalc}[1][]{%
    \useKVdefault[tnslog@step@calc@keys]%
    \setKV[tnslog@step@calc@keys]{#1}%
    \def\style{\useKV[tnslog@step@calc@keys]{style}}%
% Comments
    \IfStrEq{\useKV[tnslog@step@calc@keys]{com}}{al}{%
        \renewcommand\tnslog@com@this@no@star\tnslog@com@this@aligned%
        \renewcommand\tnslog@expl@next@extra@column{&}
    }{%
        \renewcommand\tnslog@com@this@no@star\tnslog@com@this@star%
        \renewcommand\tnslog@expl@next@extra@column{}
    }%
    \IfEqCase{\style}{%
% University
        {u}{%
            \begin{tnslog@step@calc@university}%
            \global\boolfalse{tnslog@inside@step@calc@short@arrow@star@}%
        }%
% Arrows (long)
        {ar}{%
            \begin{tnslog@step@calc@arrow}%
            \global\boolfalse{tnslog@inside@step@calc@short@arrow@star@}%
        }%
% Arrows (long + operator in margin)
        {ar*}{%
            \begin{tnslog@step@calc@arrow}%
            \global\booltrue{tnslog@inside@step@calc@short@arrow@star@}%
        }%
% Arrows (short)
        {sar}{%
            \begin{tnslog@step@calc@short@arrow}%
            \global\boolfalse{tnslog@inside@step@calc@short@arrow@star@}%
        }%
    }[%
        \PackageError{tnslog}{unknown style}%
                             {You can use u (default), ar, ar* or sar.}%
    ]%
}{%
    \IfEqCase{\style}{%
% University
        {u}{%
            \end{tnslog@step@calc@university}%
        }%
% Arrows (long)
        {ar}{%
            \end{tnslog@step@calc@arrow}%
        }%
% Arrows (long + operator in margin)
        {ar*}{%
            \end{tnslog@step@calc@arrow}%
        }%
% Arrows (short)
        {sar}{%
            \end{tnslog@step@calc@short@arrow}%
        }%
    }%
}
    
    
% University version

% For the good extra lengths, see :
%    * https://tex.stackexchange.com/a/550837/6880

\newcommand\dimmax[2]{%
    \ifdim#1>#2 #1\else #2\fi
}

\newlength{\tnslog@upper@text@size}
\newlength{\tnslog@lower@text@size}

\newcommand\samesizeas[2]{%
    \settowidth\tnslog@upper@text@size{#1}%
    \settowidth\tnslog@lower@text@size{#2}%
    \makebox[\dimmax{\tnslog@upper@text@size}{\tnslog@lower@text@size}][c]{#1}%
}


\newcommand\expltxt[1]{%
    \text{\color{blue}\footnotesize \{\,{\itshape #1}\,\} }%
}

\newcommand\expltxtup[1]{%
    $\uparrow$ #1 $\uparrow$%
}

\newcommand\expltxtdown[1]{%
    $\downarrow$ #1 $\downarrow$%
}

\newcommand\expltxtupdown[2]{{%
    \displaystyle\footnotesize\color{blue}%
    \left\{\,%
        \genfrac{}{}{0pt}{}{%
            \text{\itshape\expltxtdown{\samesizeas{#1}{#2}}}%
        }{%
            \text{\itshape\expltxtup{\samesizeas{#2}{#1}}}%
        }%
    \,\right\}%
}}


\newcommand\tnslog@expl@next@university@no@star[2][\tnslog@step@calc@ope]{
    \\&
    {#1}
    \if\relax\detokenize{#2}\relax\else
        {} \kern\expltxtspacein \expltxt{#2}
    \fi
    \\&
}

\newcommand\tnslog@expl@next@university@separation{
    \\&
}


\newcommand\tnslog@expl@next@university@star[3][\tnslog@step@calc@ope]{
    \if\relax\detokenize{#2}\relax%
        \if\relax\detokenize{#3}\relax%
            \PackageError{tnslog}{two empty arguments}%
                                 {at least one none empty text is needed}%
        \fi%
    \fi%
    %
    \tnslog@expl@next@university@separation{}%
    \if\relax\detokenize{#2}\relax%
% Up empty
%     + Down none empty
        {#1}\kern\expltxtspacein%
        \expltxt{\expltxtup{\samesizeas{#3}{#2}}}%
    \else%
% Up none empty
%     + Down empty
        \if\relax\detokenize{#3}\relax%
            {#1}\kern\expltxtspacein{}%
            \expltxt{\expltxtdown{\samesizeas{#2}{#3}}}%
%     + Down none empty
        \else%
            {#1}\kern\expltxtspacein{}%
            \expltxtupdown{#2}{#3}%
        \fi%
    \fi%
    \tnslog@expl@next@extra@column{}
    \tnslog@expl@next@university@separation{}
}


\newenvironment{tnslog@step@calc@university}{
    \setlength{\abovedisplayskip}{0pt}%
    \setlength{\belowdisplayskip}{0pt}%
    \renewcommand\tnslog@step@calc@ope{\useKV[tnslog@step@calc@keys]{ope}}%
    \renewcommand\tnslog@expl@next@no@star\tnslog@expl@next@university@no@star%
    \renewcommand\tnslog@expl@next@star\tnslog@expl@next@university@star%
    \IfStrEq{\useKV[tnslog@step@calc@keys]{com}}{al}{%
        $\WithArrows[format = rll]
    }{%
        $\WithArrows[format = rl]
    }
            &
}{%
         \endWithArrows$
}


% Middle school version

\newcommand\tnslog@expl@next@middle@school@no@star[2][\tnslog@step@calc@ope]{%
    \ifbool{tnslog@com@this@no@star@used}{}{%
        \tnslog@expl@next@extra@column{}%
    }%
    \global\boolfalse{tnslog@com@this@no@star@used}%
    %
    %
    \ifbool{tnslog@inside@step@calc@short@arrow@}{%
        \ifbool{tnslog@start@step@calc@arrow@}{%
            \if\relax\detokenize{#2}\relax\else
                \PackageError{tnslog}{illegal argument to start stepcalc[style = sar]}%
                                     {no argument for the first use of explnext in stepcalc[style = sar]}%
            \fi%
            \global\boolfalse{tnslog@start@step@calc@arrow@}%
        }{
            \if\relax\detokenize{#2}\relax\else
                \Arrow[tikz = <->]{#2}
            \fi
            \\
        }
    }{
       \if\relax\detokenize{#2}\relax\else
            \Arrow[tikz = <->]{#2}
        \fi
        \\
    }%
    \ifbool{tnslog@inside@step@calc@short@arrow@star@}{%
	    \llap{$#1$}\;%
	}{%
		#1%
	}%
	&%
}

% Source
% https://tex.stackexchange.com/a/550754/6880

\NewDocumentCommand \@double@arrow@{O {} m m}{
    \Arrow[   tikz = -> , #1]{#2}%
    \Arrow[o, tikz = <- , #1]{#3}
}
 

\newcommand\tnslog@expl@next@middle@school@star[3][\tnslog@step@calc@ope]{
    \ifbool{tnslog@com@this@no@star@used}{}{%
        \tnslog@expl@next@extra@column{}%
    }%
    \global\boolfalse{tnslog@com@this@no@star@used}%
    %
    \if\relax\detokenize{#2}\relax%
        \if\relax\detokenize{#3}\relax%
            \PackageError{tnslog}{two empty arguments}%
                                 {at least one none empty text is needed}
        \else%
            \Arrow[tikz = <-]{#3}%
        \fi%
    \else%
        \if\relax\detokenize{#3}\relax%
            \Arrow[tikz = ->]{#2}%
        \else%
            \@double@arrow@{#2}{#3}
        \fi%
    \fi%
    \\
    \ifbool{tnslog@inside@step@calc@short@arrow@star@}{%
	    \llap{$#1$}\;%
	}{%
		#1%
	}%
	&%
}


\newbool{tnslog@start@step@calc@arrow@}

\newbool{tnslog@com@this@no@star@used}
\newbool{tnslog@inside@step@calc@short@arrow@}


\newenvironment{tnslog@step@calc@arrow}{
    \renewcommand\tnslog@expl@next@no@star\tnslog@expl@next@middle@school@no@star%
    \renewcommand\tnslog@expl@next@star\tnslog@expl@next@middle@school@star%
    \renewcommand\tnslog@step@calc@ope{\useKV[tnslog@step@calc@keys]{ope}}%
    %
    \boolfalse{tnslog@inside@step@calc@short@arrow@}%
    \boolfalse{tnslog@start@step@calc@arrow@}%
    \boolfalse{tnslog@com@this@no@star@used}%
    %
    \IfStrEq{\useKV[tnslog@step@calc@keys]{com}}{al}{%
        $\WithArrows[tikz = blue, groups, format = Rll]
    }{%
        $\WithArrows[tikz = blue, groups, format = Rl]
    }
            &
}{%
         \endWithArrows$
}

\newenvironment{tnslog@step@calc@short@arrow}{
    \renewcommand\tnslog@expl@next@no@star\tnslog@expl@next@middle@school@no@star%
    \renewcommand\tnslog@expl@next@star\tnslog@expl@next@middle@school@star%
    \renewcommand\tnslog@step@calc@ope{\useKV[tnslog@step@calc@keys]{ope}}%
    %
    \booltrue{tnslog@inside@step@calc@short@arrow@}%
    \booltrue{tnslog@start@step@calc@arrow@}%
    \boolfalse{tnslog@com@this@no@star@used}%
    %
    %
    \IfStrEq{\useKV[tnslog@step@calc@keys]{com}}{al}{%
        $\WithArrows[tikz = blue, groups, format = Rll]%
    }{%
        $\WithArrows[tikz = blue, groups, format = Rl]%
    }%
}{%
         \endWithArrows$
}


% ------------- %
% -- DEMOTAB -- %
% ------------- %

%    * Texts used

\newcommand\txtdemoID{Réf.}
\newcommand\txtdemoKNOWN{Je sais que...}
\newcommand\txtdemoPROP{Propriété ou fait utilisé}
\newcommand\txtdemoCONS{Conséquence}

\newcommand\txtdemoHYPS{Démonstration sous les hypothèses}
\newcommand\txtdemoHYP{Démonstration sous l'hypothèse}
\newcommand\txtdemoCCL{Conclusion}

\newcommand\txtdemoNEXTPAGE{Suite de la démo. page suivante...}


%    * Common tools

\newcommand\explref{\@ifstar{\tnslog@expl@ref@star}{\tnslog@expl@ref@no@star}}

\newcommand\tnslog@expl@ref@star[1]{%
    \framebox[1.5em]{#1}%
}

\newcommand\tnslog@expl@ref@no@star[1]{%
    \tnslog@expl@ref@star{\ref{#1}}%
}

\newcommand\demostep{}


%    * University version 

\newcounter{tnslog@demo@tab@id}


\newcommand\@expl@id[1]{%
    \framebox[1.5em]{\thetnslog@demo@tab@id}%
    \if\relax\detokenize{#1}\relax\else%
        \addtocounter{tnslog@demo@tab@id}{-1}%
        \refstepcounter{tnslog@demo@tab@id}\label{#1}
    \fi
    \stepcounter{tnslog@demo@tab@id}%
}


\newbool{tnslog@start@demo@tab} 


\newcommand\@demostep@no@star[1][]{%
    \ifbool{tnslog@start@demo@tab}{%
        \global\boolfalse{tnslog@start@demo@tab}%
    }{%
        \\
    }%
    \@expl@id{#1}
    &
}


\setKVdefault[tnslog@demo@tab@keys]{%
    start = 1,
    hyps  = {},
    hyp   = {},
    ccl   = {}
}


\newenvironment{demotab}[1][]{
    \renewcommand\demostep\@demostep@no@star
    \useKVdefault[tnslog@demo@tab@keys]
    \setKV[tnslog@demo@tab@keys]{#1}
    %
    \ifthenelse{\equal{\useKV[tnslog@demo@tab@keys]{start}}{last}}{
    % If no environment has been used before !
        \ifnum\value{tnslog@demo@tab@id}<1
            \setcounter{tnslog@demo@tab@id}{1}
        \fi
    }{%
        \setcounter{tnslog@demo@tab@id}{\useKV[tnslog@demo@tab@keys]{start}}%
    }%
    \def\hyps{\useKV[tnslog@demo@tab@keys]{hyps}}
    \def\hyp{\useKV[tnslog@demo@tab@keys]{hyp}}
    \edef\ccl{\useKV[tnslog@demo@tab@keys]{ccl}}
    %
    \if\relax\hyps\relax\else%
        \if\relax\hyp\relax\else%
            \PackageError{tnslog}{hyps and hyp are both used}%
                                 {use either hyps or hyp, or none of them}
        \fi
    \fi
    %
    \if\relax\hyps\relax\else%
        \underline{\txtdemoHYPS\vphantom{p\txtdemoCCL}} : \hyps
        \vspace{-.25em}
    \fi
    \if\relax\hyp\relax\else%
        \underline{\txtdemoHYP\vphantom{p\txtdemoCCL}} : \hyp
        \vspace{-.25em}
    \fi
    \booltrue{tnslog@start@demo@tab}
    \begin{longtable}{lll}
        \multicolumn{3}{c}{}
        \\[-.5em]
        \multicolumn{3}{c}{%
            \textit{\tnslog@demo@extra{\txtdemoNEXTPAGE}}%
        }
        \endfoot
        \endlastfoot
}{
    \end{longtable}
    \if\relax\ccl\relax\else%
        \vspace{-.25em}
        \underline{\txtdemoCCL\vphantom{\txtdemoHYPS}} : \ccl
    \fi
}


%    * Middle school version

\newbool{tnslog@start@demo@tab@star}

\newcounter{tnslog@demo@tab@star@id}


\newcommand\tnslog@demo@extra[1]{%
    {\footnotesize#1}%
}


\newcommand\tnslog@expl@star@id[1]{%
    \thetnslog@demo@tab@star@id%
    \if\relax\detokenize{#1}\relax\else%
        \addtocounter{tnslog@demo@tab@star@id}{-1}%
        \refstepcounter{tnslog@demo@tab@star@id}\label{#1}
    \fi
    \stepcounter{tnslog@demo@tab@star@id}%
}


\newcommand\tnslog@demostep@star[1][]{%
    \ifbool{tnslog@start@demo@tab@star}{%
        \global\boolfalse{tnslog@start@demo@tab@star}%
    }{%
        \\
        \hline%
    }%
    \tnslog@expl@star@id{#1}%
    &
}


\setKVdefault[tnslog@demo@tab@star@keys]{%
    start = 1
}


\newenvironment{demotab*}[1][]{
    \renewcommand\demostep\tnslog@demostep@star
    \useKVdefault[tnslog@demo@tab@star@keys]
    \setKV[tnslog@demo@tab@star@keys]{#1}
    %
    \ifthenelse{\equal{\useKV[tnslog@demo@tab@star@keys]{start}}{last}}{
    % If no environment has been used before !
        \ifnum\value{tnslog@demo@tab@star@id}<1
            \setcounter{tnslog@demo@tab@star@id}{1}
        \fi
    }{%
        \setcounter{tnslog@demo@tab@star@id}{\useKV[tnslog@demo@tab@star@keys]{start}}%
    }%
    \booltrue{tnslog@start@demo@tab@star}
    \small
    \renewcommand{\arraystretch}{1.5}
    \begin{longtable}{c|p{0.29\linewidth}|p{0.29\linewidth}|p{0.29\linewidth}}
        \textbf{\tnslog@demo@extra{\txtdemoID}}
            & \textbf{\tnslog@demo@extra{\txtdemoKNOWN}}
            & \textbf{\tnslog@demo@extra{\txtdemoPROP}}
            & \textbf{\tnslog@demo@extra{\txtdemoCONS}}
        \\ \hline
        \endfirsthead
        %
        \textbf{\tnslog@demo@extra{\txtdemoID}}
            & \textbf{\tnslog@demo@extra{\txtdemoKNOWN}}
            & \textbf{\tnslog@demo@extra{\txtdemoPROP}}
            & \textbf{\tnslog@demo@extra{\txtdemoCONS}}
        \\ \hline
        \endhead
        %
        \multicolumn{3}{c}{}
        \\[-1.25em]
        \multicolumn{4}{c}{%
            \textit{\tnslog@demo@extra{\txtdemoNEXTPAGE}}%
        }
        \\
        \endfoot

        \endlastfoot
}{
    \end{longtable}
    \renewcommand{\arraystretch}{1}
}
