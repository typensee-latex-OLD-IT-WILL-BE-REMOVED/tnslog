% ---------------------- %
% -- IMPORTS REQUIRED -- %
% ---------------------- %

% A
\RequirePackage{amssymb}
% C
\RequirePackage{centernot}
% E
\RequirePackage{etoolbox}
% L
\RequirePackage{longtable}
% M
\RequirePackage{mathtools}
% S
\RequirePackage{simplekv}
% T
\RequirePackage{tnscom}
% W
\RequirePackage{witharrows}


% --------------------- %
% -- SPACE LOGIC NEG -- %
% --------------------- %

% Logic negation roots

\let\stdneg\neg
\renewcommand\neg{%
    \stdneg\,%
}


% ---------------------- %
% -- EQUAL SIGNS N CO -- %
% ---------------------- %

% Settable texts
\@ifpackagewith{babel}{french}{
% == Decorations - FRENCH - START == %
    \newcommand\txtopappli{appli}
    \newcommand\txtopchoice{choix}
    \newcommand\txtopcond{cond}
    \newcommand\txtopcons{cons}
    \newcommand\txtopdef{d√©f}
    \newcommand\txtopplot{graph}
    \newcommand\txtophyp{hyp}
    \newcommand\txtopid{id}
    \newcommand\txtoptest{?}
% == Decorations - FRENCH - END == %
}{
% == Decorations - ENGLISH - START == %
    \newcommand\txtopappli{appli}
    \newcommand\txtopchoice{choice}
    \newcommand\txtopcond{cond}
    \newcommand\txtopcons{cons}
    \newcommand\txtopdef{def}
    \newcommand\txtopplot{plot}
    \newcommand\txtophyp{hyp}
    \newcommand\txtopid{id}
    \newcommand\txtoptest{?}
% == Decorations - ENGLISH - END == %
}


% == Decorated versions - START == %

\newcommand\eqdef{\@ifstar{\tnslog@eqdef@star}{\tnslog@eqdef@no@star}}
\newcommand\tnslog@eqdef@no@star{\tns@over@math@symbol{\txtopdef}{=}}
\newcommand\tnslog@eqdef@star{\coloneqq}

\newcommand\eqid{\@ifstar{\tnslog@eqid@star}{\tnslog@eqid@no@star}}
\newcommand\tnslog@eqid@no@star{\tns@over@math@symbol{\txtopid}{=}}
\newcommand\tnslog@eqid@star{\rightleftharpoons}

\newcommand\eqplot{\tns@over@math@symbol{\txtopplot}{=}}
\newcommand\eqappli{\tns@over@math@symbol{\txtopappli}{=}}
\newcommand\eqchoice{\tns@over@math@symbol{\txtopchoice}{=}}
\newcommand\eqcond{\tns@over@math@symbol{\txtopcond}{=}}
\newcommand\eqcons{\tns@over@math@symbol{\txtopcons}{=}}
\newcommand\eqhyp{\tns@over@math@symbol{\txtophyp}{=}}
\newcommand\eqtest{\tns@over@math@symbol{\txtoptest}{=}}

\newcommand\neqid{\tns@over@math@symbol{\txtopid}{\neq}}
\newcommand\neqplot{\tns@over@math@symbol{\txtopplot}{\neq}}
\newcommand\neqappli{\tns@over@math@symbol{\txtopappli}{\neq}}
\newcommand\neqchoice{\tns@over@math@symbol{\txtopchoice}{\neq}}
\newcommand\neqcond{\tns@over@math@symbol{\txtopcond}{\neq}}
\newcommand\neqcons{\tns@over@math@symbol{\txtopcons}{\neq}}
\newcommand\neqhyp{\tns@over@math@symbol{\txtophyp}{\neq}}
\newcommand\neqtest{\tns@over@math@symbol{\txtoptest}{\neq}}

\newcommand\lessplot{\tns@over@math@symbol{\txtopplot}{<}}
\newcommand\lessappli{\tns@over@math@symbol{\txtopappli}{<}}
\newcommand\lesschoice{\tns@over@math@symbol{\txtopchoice}{<}}
\newcommand\lesscond{\tns@over@math@symbol{\txtopcond}{<}}
\newcommand\lesscons{\tns@over@math@symbol{\txtopcons}{<}}
\newcommand\lesshyp{\tns@over@math@symbol{\txtophyp}{<}}
\newcommand\lesstest{\tns@over@math@symbol{\txtoptest}{<}}

\newcommand\nlessplot{\tns@over@math@symbol{\txtopplot}{\nless}}
\newcommand\nlessappli{\tns@over@math@symbol{\txtopappli}{\nless}}
\newcommand\nlesschoice{\tns@over@math@symbol{\txtopchoice}{\nless}}
\newcommand\nlesscond{\tns@over@math@symbol{\txtopcond}{\nless}}
\newcommand\nlesscons{\tns@over@math@symbol{\txtopcons}{\nless}}
\newcommand\nlesshyp{\tns@over@math@symbol{\txtophyp}{\nless}}
\newcommand\nlesstest{\tns@over@math@symbol{\txtoptest}{\nless}}

\newcommand\leqplot{\tns@over@math@symbol{\txtopplot}{\leq}}
\newcommand\leqappli{\tns@over@math@symbol{\txtopappli}{\leq}}
\newcommand\leqchoice{\tns@over@math@symbol{\txtopchoice}{\leq}}
\newcommand\leqcond{\tns@over@math@symbol{\txtopcond}{\leq}}
\newcommand\leqcons{\tns@over@math@symbol{\txtopcons}{\leq}}
\newcommand\leqhyp{\tns@over@math@symbol{\txtophyp}{\leq}}
\newcommand\leqtest{\tns@over@math@symbol{\txtoptest}{\leq}}

\newcommand\nleqplot{\tns@over@math@symbol{\txtopplot}{\nleq}}
\newcommand\nleqappli{\tns@over@math@symbol{\txtopappli}{\nleq}}
\newcommand\nleqchoice{\tns@over@math@symbol{\txtopchoice}{\nleq}}
\newcommand\nleqcond{\tns@over@math@symbol{\txtopcond}{\nleq}}
\newcommand\nleqcons{\tns@over@math@symbol{\txtopcons}{\nleq}}
\newcommand\nleqhyp{\tns@over@math@symbol{\txtophyp}{\nleq}}
\newcommand\nleqtest{\tns@over@math@symbol{\txtoptest}{\nleq}}

\newcommand\gtrplot{\tns@over@math@symbol{\txtopplot}{>}}
\newcommand\gtrappli{\tns@over@math@symbol{\txtopappli}{>}}
\newcommand\gtrchoice{\tns@over@math@symbol{\txtopchoice}{>}}
\newcommand\gtrcond{\tns@over@math@symbol{\txtopcond}{>}}
\newcommand\gtrcons{\tns@over@math@symbol{\txtopcons}{>}}
\newcommand\gtrhyp{\tns@over@math@symbol{\txtophyp}{>}}
\newcommand\gtrtest{\tns@over@math@symbol{\txtoptest}{>}}

\newcommand\ngtrplot{\tns@over@math@symbol{\txtopplot}{\ngtr}}
\newcommand\ngtrappli{\tns@over@math@symbol{\txtopappli}{\ngtr}}
\newcommand\ngtrchoice{\tns@over@math@symbol{\txtopchoice}{\ngtr}}
\newcommand\ngtrcond{\tns@over@math@symbol{\txtopcond}{\ngtr}}
\newcommand\ngtrcons{\tns@over@math@symbol{\txtopcons}{\ngtr}}
\newcommand\ngtrhyp{\tns@over@math@symbol{\txtophyp}{\ngtr}}
\newcommand\ngtrtest{\tns@over@math@symbol{\txtoptest}{\ngtr}}

\newcommand\geqplot{\tns@over@math@symbol{\txtopplot}{\geq}}
\newcommand\geqappli{\tns@over@math@symbol{\txtopappli}{\geq}}
\newcommand\geqchoice{\tns@over@math@symbol{\txtopchoice}{\geq}}
\newcommand\geqcond{\tns@over@math@symbol{\txtopcond}{\geq}}
\newcommand\geqcons{\tns@over@math@symbol{\txtopcons}{\geq}}
\newcommand\geqhyp{\tns@over@math@symbol{\txtophyp}{\geq}}
\newcommand\geqtest{\tns@over@math@symbol{\txtoptest}{\geq}}

\newcommand\ngeqplot{\tns@over@math@symbol{\txtopplot}{\ngeq}}
\newcommand\ngeqappli{\tns@over@math@symbol{\txtopappli}{\ngeq}}
\newcommand\ngeqchoice{\tns@over@math@symbol{\txtopchoice}{\ngeq}}
\newcommand\ngeqcond{\tns@over@math@symbol{\txtopcond}{\ngeq}}
\newcommand\ngeqcons{\tns@over@math@symbol{\txtopcons}{\ngeq}}
\newcommand\ngeqhyp{\tns@over@math@symbol{\txtophyp}{\ngeq}}
\newcommand\ngeqtest{\tns@over@math@symbol{\txtoptest}{\ngeq}}

% == Decorated versions - END == %


% --------------- %
% -- OPERATORS -- %
% --------------- %

% Vertical versions 

\newcommand\vliesimp{\mathrel{\Uparrow}}
\newcommand\vimplies{\mathrel{\Downarrow}}
\newcommand\viff{\mathrel{\Updownarrow}}

\newcommand\nvliesimp{\centernot\vliesimp}
\newcommand\nvimplies{\centernot\vimplies}
\newcommand\nviff{\centernot\viff}


% Horizontal versions



% == Decorated versions - START == %

\newcommand\niff{\centernot\iff}
\newcommand\nimplies{\centernot\implies}
\newcommand\liesimp{\mathrel{\Longleftarrow}}
\newcommand\nliesimp{\centernot\liesimp}

\newcommand\iffappli{\tns@over@math@symbol{\txtopappli}{\iff}}
\newcommand\iffchoice{\tns@over@math@symbol{\txtopchoice}{\iff}}
\newcommand\iffcond{\tns@over@math@symbol{\txtopcond}{\iff}}
\newcommand\iffcons{\tns@over@math@symbol{\txtopcons}{\iff}}
\newcommand\iffhyp{\tns@over@math@symbol{\txtophyp}{\iff}}
\newcommand\ifftest{\tns@over@math@symbol{\txtoptest}{\iff}}

\newcommand\niffappli{\tns@over@math@symbol{\txtopappli}{\niff}}
\newcommand\niffchoice{\tns@over@math@symbol{\txtopchoice}{\niff}}
\newcommand\niffcond{\tns@over@math@symbol{\txtopcond}{\niff}}
\newcommand\niffcons{\tns@over@math@symbol{\txtopcons}{\niff}}
\newcommand\niffhyp{\tns@over@math@symbol{\txtophyp}{\niff}}
\newcommand\nifftest{\tns@over@math@symbol{\txtoptest}{\niff}}

\newcommand\impliesappli{\tns@over@math@symbol{\txtopappli}{\implies}}
\newcommand\implieschoice{\tns@over@math@symbol{\txtopchoice}{\implies}}
\newcommand\impliescond{\tns@over@math@symbol{\txtopcond}{\implies}}
\newcommand\impliescons{\tns@over@math@symbol{\txtopcons}{\implies}}
\newcommand\implieshyp{\tns@over@math@symbol{\txtophyp}{\implies}}
\newcommand\impliestest{\tns@over@math@symbol{\txtoptest}{\implies}}

\newcommand\nimpliesappli{\tns@over@math@symbol{\txtopappli}{\nimplies}}
\newcommand\nimplieschoice{\tns@over@math@symbol{\txtopchoice}{\nimplies}}
\newcommand\nimpliescond{\tns@over@math@symbol{\txtopcond}{\nimplies}}
\newcommand\nimpliescons{\tns@over@math@symbol{\txtopcons}{\nimplies}}
\newcommand\nimplieshyp{\tns@over@math@symbol{\txtophyp}{\nimplies}}
\newcommand\nimpliestest{\tns@over@math@symbol{\txtoptest}{\nimplies}}

\newcommand\liesimpappli{\tns@over@math@symbol{\txtopappli}{\liesimp}}
\newcommand\liesimpchoice{\tns@over@math@symbol{\txtopchoice}{\liesimp}}
\newcommand\liesimpcond{\tns@over@math@symbol{\txtopcond}{\liesimp}}
\newcommand\liesimpcons{\tns@over@math@symbol{\txtopcons}{\liesimp}}
\newcommand\liesimphyp{\tns@over@math@symbol{\txtophyp}{\liesimp}}
\newcommand\liesimptest{\tns@over@math@symbol{\txtoptest}{\liesimp}}

\newcommand\nliesimpappli{\tns@over@math@symbol{\txtopappli}{\nliesimp}}
\newcommand\nliesimpchoice{\tns@over@math@symbol{\txtopchoice}{\nliesimp}}
\newcommand\nliesimpcond{\tns@over@math@symbol{\txtopcond}{\nliesimp}}
\newcommand\nliesimpcons{\tns@over@math@symbol{\txtopcons}{\nliesimp}}
\newcommand\nliesimphyp{\tns@over@math@symbol{\txtophyp}{\nliesimp}}
\newcommand\nliesimptest{\tns@over@math@symbol{\txtoptest}{\nliesimp}}

% == Decorated versions - END == %


% ----------------- %
% -- QUANTIFIERS -- %
% ----------------- %

\newcommand\existsone{\exists\kern0.1em !}
\newcommand\nexistsone{\nexists\kern0.1em !}

\newcommand\existmulti[1]{\exists_{\kern0.1em #1}}
\newcommand\nexistmulti[1]{\nexists_{\kern0.1em #1}}


% -------------------- %
% -- CALC EXPLAINED -- %
% -------------------- %

% Space

\newcommand\expltxtspacein{2em}


% Common tools

\newcommand\explcom[1]{%
    \text{\color{purple}[\kern.225em{\footnotesize \itshape #1}\kern.3em]}%
}


\newcommand\explnext{\@ifstar{\tnslog@expl@next@star}{\tnslog@expl@next@no@star}}
\newcommand\tnslog@expl@next@no@star{}
\newcommand\tnslog@expl@next@star{}

\newcommand\tnslog@explain@ope{=}


\newcommand\comthis{\@ifstar{\tnslog@com@this@star}{\tnslog@com@this@no@star}}
\newcommand\tnslog@com@this@no@star{}

\newcommand\tnslog@com@this@star[1]{%
    \ifbool{tnslog@starttnslog@explain@arrow@}{%
        \PackageError{tnslog}{comment can't be use to start explain[style = sar]}%
                             {No comment for the 1st part of explain[style = sar]}
    }{%
        \kern\expltxtspacein\explcom{#1}%
    }%
}

\newcommand\tnslog@com@this@aligned[1]{%
    \global\booltrue{tnslog@com@this@no@star@used}%
    &%
    \tnslog@com@this@star{#1}%
}


\newcommand\tnslog@expl@next@extra@column{}


% Wrapper env with key-val options 

\setKVdefault[tnslog@calc@explain@keys]{%
    ope   = {=},
    style = u,
    com   = nal
}

\newenvironment{explain}[1][]{%
    \useKVdefault[tnslog@calc@explain@keys]%
    \setKV[tnslog@calc@explain@keys]{#1}%
    \def\style{\useKV[tnslog@calc@explain@keys]{style}}%
% Comments
    \IfStrEq{\useKV[tnslog@calc@explain@keys]{com}}{al}{%
        \renewcommand\tnslog@com@this@no@star\tnslog@com@this@aligned%
        \renewcommand\tnslog@expl@next@extra@column{&}
    }{%
        \renewcommand\tnslog@com@this@no@star\tnslog@com@this@star%
        \renewcommand\tnslog@expl@next@extra@column{}
    }%
    \IfEqCase{\style}{%
% University
        {u}{%
            \begin{tnslog@explain@university}%
        }%
% Arrows (long)
        {ar}{%
            \begin{tnslog@explain@arrow}%
        }%
% Arrows (short)
        {sar}{%
            \begin{tnslog@explain@short@arrow}%
        }%
    }[%
        \PackageError{tnslog}{unknown style}%
                             {You can use u (default), ar or sar.}%
    ]%
}{%
    \IfEqCase{\style}{%
% University
        {u}{%
            \end{tnslog@explain@university}%
        }%
% Arrows (long)
        {ar}{%
            \end{tnslog@explain@arrow}%
        }%
% Arrows (short)
        {sar}{%
            \end{tnslog@explain@short@arrow}%
        }%
    }%
}
    
    
% University version

% For the good extra lengths, see :
%    * https://tex.stackexchange.com/a/550837/6880

\newcommand\dimmax[2]{%
    \ifdim#1>#2 #1\else #2\fi
}

\newlength{\tnslog@upper@text@size}
\newlength{\tnslog@lower@text@size}

\newcommand\samesizeas[2]{%
    \settowidth\tnslog@upper@text@size{#1}%
    \settowidth\tnslog@lower@text@size{#2}%
    \makebox[\dimmax{\tnslog@upper@text@size}{\tnslog@lower@text@size}][c]{#1}%
}



\newcommand\expltxt[1]{%
    \text{\color{blue}\footnotesize \{\,{\itshape #1}\,\} }%
}

\newcommand\expltxtup[1]{%
    $\uparrow$ #1 $\uparrow$%
}

\newcommand\expltxtdown[1]{%
    $\downarrow$ #1 $\downarrow$%
}

\newcommand\expltxtupdown[2]{{%
    \displaystyle\footnotesize\color{blue}%
    \left\{\,%
        \genfrac{}{}{0pt}{}{%
            \text{\itshape\expltxtdown{\samesizeas{#1}{#2}}}%
        }{%
            \text{\itshape\expltxtup{\samesizeas{#2}{#1}}}%
        }%
    \,\right\}%
}}



\newcommand\tnslog@expl@next@university@no@star[2][\tnslog@explain@ope]{
    \\&
    {#1}
    \if\relax\detokenize{#2}\relax\else
        {} \kern\expltxtspacein \expltxt{#2}
    \fi
    \\&
}

\newcommand\tnslog@expl@next@university@separation{
    \\&
}



\newcommand\tnslog@expl@next@university@star[3][\tnslog@explain@ope]{
    \if\relax\detokenize{#2}\relax%
        \if\relax\detokenize{#3}\relax%
            \PackageError{tnslog}{two empty arguments}%
                                 {at least one none empty text is needed}
        \fi%
    \fi%
    %
    \tnslog@expl@next@university@separation{}%
    \if\relax\detokenize{#2}\relax%
% Up empty
%     + Down none empty
        {#1}\kern\expltxtspacein%
        \expltxt{\expltxtup{\samesizeas{#3}{#2}}}%
    \else%
% Up none empty
%     + Down empty
        \if\relax\detokenize{#3}\relax%
            {#1}\kern\expltxtspacein{}%
            \expltxt{\expltxtdown{\samesizeas{#2}{#3}}}%
%     + Down none empty
        \else%
            {#1}\kern\expltxtspacein{}%
            \expltxtupdown{#2}{#3}%
        \fi%
    \fi%
    \tnslog@expl@next@extra@column{}
    \tnslog@expl@next@university@separation{}
}


\newenvironment{tnslog@explain@university}{
    \setlength{\abovedisplayskip}{0pt}%
    \setlength{\belowdisplayskip}{0pt}%
    \renewcommand\tnslog@explain@ope{\useKV[tnslog@calc@explain@keys]{ope}}%
    \renewcommand\tnslog@expl@next@no@star\tnslog@expl@next@university@no@star%
    \renewcommand\tnslog@expl@next@star\tnslog@expl@next@university@star%
    \IfStrEq{\useKV[tnslog@calc@explain@keys]{com}}{al}{%
        $\WithArrows[format = rll]
    }{%
        $\WithArrows[format = rl]
    }
            &
}{%
         \endWithArrows$
}


% Middle school version

\newcommand\tnslog@expl@next@middle@school@no@star[2][\tnslog@explain@ope]{%
    \ifbool{tnslog@com@this@no@star@used}{}{%
        \tnslog@expl@next@extra@column{}%
    }%
    \global\boolfalse{tnslog@com@this@no@star@used}%
    %
    %
    \ifbool{tnslog@insidetnslog@explain@short@arrow@}{%
        \ifbool{tnslog@starttnslog@explain@arrow@}{%
            \if\relax\detokenize{#2}\relax\else
                \PackageError{tnslog}{illegal argument to start explain[style = sar]}%
                                     {no argument for the first use of explnext in [style = sar]}
            \fi
            \global\boolfalse{tnslog@starttnslog@explain@arrow@}%
        }{
            \if\relax\detokenize{#2}\relax\else
                \Arrow[tikz = <->]{#2}
            \fi
            \\
        }
    }{
        \if\relax\detokenize{#2}\relax\else
            \Arrow[tikz = <->]{#2}
        \fi
        \\
    }%
    &#1%
}

% Source
% https://tex.stackexchange.com/a/550754/6880

\NewDocumentCommand \@double@arrow@{O {} m m}{
    \Arrow[   tikz = -> , #1]{#2}%
    \Arrow[o, tikz = <- , #1]{#3}
}
 

\newcommand\tnslog@expl@next@middle@school@star[3][\tnslog@explain@ope]{
    \ifbool{tnslog@com@this@no@star@used}{}{%
        \tnslog@expl@next@extra@column{}%
    }%
    \global\boolfalse{tnslog@com@this@no@star@used}%
    %
    \if\relax\detokenize{#2}\relax%
        \if\relax\detokenize{#3}\relax%
            \PackageError{tnslog}{two empty arguments}%
                                 {at least one none empty text is needed}
        \else%
            \Arrow[tikz = <-]{#3}%
        \fi%
    \else%
        \if\relax\detokenize{#3}\relax%
            \Arrow[tikz = ->]{#2}%
        \else%
            \@double@arrow@{#2}{#3}
        \fi%
    \fi%
    \\
    &#1%
}

\newbool{tnslog@com@this@no@star@used} 

\newbool{tnslog@starttnslog@explain@arrow@} 
\newbool{tnslog@insidetnslog@explain@short@arrow@} 

\newenvironment{tnslog@explain@arrow}{
    \renewcommand\tnslog@expl@next@no@star\tnslog@expl@next@middle@school@no@star%
    \renewcommand\tnslog@expl@next@star\tnslog@expl@next@middle@school@star%
    \renewcommand\tnslog@explain@ope{\useKV[tnslog@calc@explain@keys]{ope}}%
    %
    \boolfalse{tnslog@insidetnslog@explain@short@arrow@}%
    \boolfalse{tnslog@starttnslog@explain@arrow@}%
    \boolfalse{tnslog@com@this@no@star@used}%
    %
    \IfStrEq{\useKV[tnslog@calc@explain@keys]{com}}{al}{%
        $\WithArrows[tikz = blue, groups, format = rll]
    }{%
        $\WithArrows[tikz = blue, groups, format = rl]
    }
            &\phantom{{}\tnslog@explain@ope{}}
}{%
         \endWithArrows$
}

\newenvironment{tnslog@explain@short@arrow}{
    \renewcommand\tnslog@expl@next@no@star\tnslog@expl@next@middle@school@no@star%
    \renewcommand\tnslog@expl@next@star\tnslog@expl@next@middle@school@star%
    \renewcommand\tnslog@explain@ope{\useKV[tnslog@calc@explain@keys]{ope}}%
    %
    \booltrue{tnslog@insidetnslog@explain@short@arrow@}%
    \booltrue{tnslog@starttnslog@explain@arrow@}%
    \boolfalse{tnslog@com@this@no@star@used}%
    %
    %
    \IfStrEq{\useKV[tnslog@calc@explain@keys]{com}}{al}{%
        $\WithArrows[tikz = blue, groups, format = rll]%
    }{%
        $\WithArrows[tikz = blue, groups, format = rl]%
    }%
}{%
         \endWithArrows$
}


% -------------------- %
% -- DEMO EXPLAINED -- %
% -------------------- %

%    * Texts used

\newcommand\textdemoID{R√©f.}
\newcommand\textdemoKNOWN{Je sais que...}
\newcommand\textdemoPROP{Propri√©t√© ou fait utilis√©}
\newcommand\textdemoCONS{Cons√©quence}

\newcommand\textdemoHYPS{D√©monstration sous les hypoth√®ses}
\newcommand\textdemoHYP{D√©monstration sous l'hypoth√®se}
\newcommand\textdemoCCL{Conclusion}

\newcommand\textdemoNEXTPAGE{Suite de la d√©mo. page suivante...}


%    * Common tools

\newcommand\explref{\@ifstar{\tnslog@expl@ref@star}{\tnslog@expl@ref@no@star}}

\newcommand\tnslog@expl@ref@star[1]{%
    \framebox[1.5em]{#1}%
}

\newcommand\tnslog@expl@ref@no@star[1]{%
    \tnslog@expl@ref@star{\ref{#1}}%
}

\newcommand\demostep{}


%    * University version 

\newcounter{tnslog@demo@explain@id}


\newcommand\@expl@id[1]{%
    \framebox[1.5em]{\thetnslog@demo@explain@id}%
    \if\relax\detokenize{#1}\relax\else%
        \addtocounter{tnslog@demo@explain@id}{-1}%
        \refstepcounter{tnslog@demo@explain@id}\label{#1}
    \fi
    \stepcounter{tnslog@demo@explain@id}%
}


\newbool{tnslog@start@demo@explain} 


\newcommand\@demostep@no@star[1][]{%
    \ifbool{tnslog@start@demo@explain}{%
        \global\boolfalse{tnslog@start@demo@explain}%
    }{%
        \\
    }%
    \@expl@id{#1}
    &
}


\setKVdefault[tnslog@demo@explain@keys]{%
    start = 1,
    hyps  = {},
    hyp   = {},
    ccl   = {}
}


\newenvironment{demoexplain}[1][]{
    \renewcommand\demostep\@demostep@no@star
    \useKVdefault[tnslog@demo@explain@keys]
    \setKV[tnslog@demo@explain@keys]{#1}
    %
    \ifthenelse{\equal{\useKV[tnslog@demo@explain@keys]{start}}{last}}{
    % If no environment has been used before !
        \ifnum\value{tnslog@demo@explain@id}<1
            \setcounter{tnslog@demo@explain@id}{1}
        \fi
    }{%
        \setcounter{tnslog@demo@explain@id}{\useKV[tnslog@demo@explain@keys]{start}}%
    }%
    \def\hyps{\useKV[tnslog@demo@explain@keys]{hyps}}
    \def\hyp{\useKV[tnslog@demo@explain@keys]{hyp}}
    \edef\ccl{\useKV[tnslog@demo@explain@keys]{ccl}}
    %
    \if\relax\hyps\relax\else%
        \if\relax\hyp\relax\else%
            \PackageError{tnslog}{hyps and hyp are both used}%
                                 {use either hyps or hyp, or none of them}
        \fi
    \fi
    %
    \if\relax\hyps\relax\else%
        \underline{\textdemoHYPS\vphantom{p\textdemoCCL}} : \hyps
        \vspace{-.25em}
    \fi
    \if\relax\hyp\relax\else%
        \underline{\textdemoHYP\vphantom{p\textdemoCCL}} : \hyp
        \vspace{-.25em}
    \fi
    \booltrue{tnslog@start@demo@explain}
    \begin{longtable}{lll}
        \multicolumn{3}{c}{}
        \\[-.5em]
        \multicolumn{3}{c}{%
            \textit{\tnslog@demo@extra{\textdemoNEXTPAGE}}%
        }
        \endfoot
        \endlastfoot
}{
    \end{longtable}
    \if\relax\ccl\relax\else%
        \vspace{-.25em}
        \underline{\textdemoCCL\vphantom{\textdemoHYPS}} : \ccl
    \fi
}


%    * Middle school version

\newbool{tnslog@start@demo@explain@star}

\newcounter{tnslog@demo@explain@star@id}


\newcommand\tnslog@demo@extra[1]{%
    {\footnotesize#1}%
}


\newcommand\tnslog@expl@star@id[1]{%
    \thetnslog@demo@explain@star@id%
    \if\relax\detokenize{#1}\relax\else%
        \addtocounter{tnslog@demo@explain@star@id}{-1}%
        \refstepcounter{tnslog@demo@explain@star@id}\label{#1}
    \fi
    \stepcounter{tnslog@demo@explain@star@id}%
}


\newcommand\tnslog@demostep@star[1][]{%
    \ifbool{tnslog@start@demo@explain@star}{%
        \global\boolfalse{tnslog@start@demo@explain@star}%
    }{%
        \\
        \hline%
    }%
    \tnslog@expl@star@id{#1}%
    &
}


\setKVdefault[tnslog@demo@explain@star@keys]{%
    start = 1
}


\newenvironment{demoexplain*}[1][]{
    \renewcommand\demostep\tnslog@demostep@star
    \useKVdefault[tnslog@demo@explain@star@keys]
    \setKV[tnslog@demo@explain@star@keys]{#1}
    %
    \ifthenelse{\equal{\useKV[tnslog@demo@explain@star@keys]{start}}{last}}{
    % If no environment has been used before !
        \ifnum\value{tnslog@demo@explain@star@id}<1
            \setcounter{tnslog@demo@explain@star@id}{1}
        \fi
    }{%
        \setcounter{tnslog@demo@explain@star@id}{\useKV[tnslog@demo@explain@star@keys]{start}}%
    }%
    \booltrue{tnslog@start@demo@explain@star}
    \small
    \renewcommand{\arraystretch}{1.5}
    \begin{longtable}{c|p{0.29\linewidth}|p{0.29\linewidth}|p{0.29\linewidth}}
        \textbf{\tnslog@demo@extra{\textdemoID}}
            & \textbf{\tnslog@demo@extra{\textdemoKNOWN}}
            & \textbf{\tnslog@demo@extra{\textdemoPROP}}
            & \textbf{\tnslog@demo@extra{\textdemoCONS}}
        \\ \hline
        \endfirsthead
        %
        \textbf{\tnslog@demo@extra{\textdemoID}}
            & \textbf{\tnslog@demo@extra{\textdemoKNOWN}}
            & \textbf{\tnslog@demo@extra{\textdemoPROP}}
            & \textbf{\tnslog@demo@extra{\textdemoCONS}}
        \\ \hline
        \endhead
        %
        \multicolumn{3}{c}{}
        \\[-1.25em]
        \multicolumn{4}{c}{%
            \textit{\tnslog@demo@extra{\textdemoNEXTPAGE}}%
        }
        \\
        \endfoot

        \endlastfoot
}{
    \end{longtable}
    \renewcommand{\arraystretch}{1}
}
